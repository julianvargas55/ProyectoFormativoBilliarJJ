<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{dashboard.title}">Dashboard Integral | TEJO JJ</title>
    
    <!-- Thymeleaf para recursos estáticos -->
    <link rel="stylesheet" th:href="@{/css/tejo.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-dashboard-container">
        
        <aside class="sidebar-menu">
            <div class="logo-sidebar">
                <i class="fas fa-hand-rock"></i> 
                <span th:text="#{app.name}">TEJO JJ</span>
            </div>
            <nav>
                <ul>
                    <li th:classappend="${#httpServletRequest.requestURI == '/indextejo'} ? 'active' : ''">
                        <a th:href="@{/indextejo}">
                            <i class="fas fa-home"></i> 
                            <span th:text="#{menu.resumen}">Resumen Operacional</span>
                        </a>
                    </li>
                    
                    <li th:classappend="${#httpServletRequest.requestURI == '/gestion-canchas'} ? 'active' : ''">
                        <a th:href="@{/gestion-canchas}">
                            <i class="fas fa-grip-lines-vertical"></i> 
                            <span th:text="#{menu.canchas}">Gestión de Canchas</span>
                        </a>
                    </li>
                    
                    <li th:classappend="${#httpServletRequest.requestURI == '/reservas'} ? 'active' : ''">
                        <a th:href="@{/reservas}">
                            <i class="fas fa-clock"></i> 
                            <span th:text="#{menu.reservas}">Tiempos y Reservas</span>
                        </a>
                    </li>
                    
                    <li th:classappend="${#httpServletRequest.requestURI == '/inventario'} ? 'active' : ''">
                        <a th:href="@{/inventario}">
                            <i class="fas fa-bomb"></i> 
                            <span th:text="#{menu.inventario}">Inventario (Discos y Mechas)</span>
                        </a>
                    </li>
                    
                    <li th:classappend="${#httpServletRequest.requestURI == '/reportes'} ? 'active' : ''">
                        <a th:href="@{/reportes}">
                            <i class="fas fa-chart-bar"></i> 
                            <span th:text="#{menu.reportes}">Reportes Financieros</span>
                        </a>
                    </li>
                    
                    <li th:classappend="${#httpServletRequest.requestURI == '/configuracion'} ? 'active' : ''">
                        <a th:href="@{/configuracion}">
                            <i class="fas fa-users-cog"></i> 
                            <span th:text="#{menu.configuracion}">Configuraciones</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a th:href="@{/logout}" th:onclick="return confirm('¿Estás seguro de que deseas cerrar sesión?')">
                    <i class="fas fa-sign-out-alt"></i> 
                    <span th:text="#{menu.cerrarSesion}">Cerrar Sesión</span>
                </a>
            </div>
        </aside>

        <main class="dashboard-content">
            
            <header class="dashboard-header">
                <h1 th:text="#{dashboard.titulo}">Operación Diaria de Tejo</h1>
                <div class="user-info" th:if="${usuario != null}">
                    <i class="fas fa-user-circle"></i> 
                    <span th:text="${usuario.nombre} + ' (' + ${usuario.rol} + ')'" 
                          style="color: var(--color-acento-principal);">Administrador</span>
                </div>
                <div class="user-info" th:unless="${usuario != null}">
                    <i class="fas fa-user-circle"></i> 
                    <span>Invitado</span>
                </div>
            </header>

            <!-- Mensajes del sistema -->
            <div th:if="${message != null}" class="alert alert-success">
                <span th:text="${message}">Operación exitosa</span>
            </div>
            <div th:if="${error != null}" class="alert alert-error">
                <span th:text="${error}">Error en la operación</span>
            </div>

            <section class="metrics-grid">
                
                <div class="metric-card">
                    <i class="fas fa-grip-lines-vertical card-icon green"></i>
                    <h2 th:text="#{metricas.canchasOcupadas}">Canchas Ocupadas</h2>
                    <p class="value" th:text="${metricas.canchasOcupadas != null ? metricas.canchasOcupadas + ' / ' + metricas.totalCanchas : '3 / 6'}">
                        3 / 6
                    </p>
                </div>
                
                <div class="metric-card">
                    <i class="fas fa-user-friends card-icon blue"></i>
                    <h2 th:text="#{metricas.reservasProximas}">Reservas (Próx. 3h)</h2>
                    <p class="value" th:text="${metricas.reservasProximas != null ? metricas.reservasProximas : '5'}">5</p>
                </div>
                
                <div class="metric-card">
                    <i class="fas fa-bomb card-icon yellow"></i>
                    <h2 th:text="#{metricas.mechasUsadas}">Mechas Usadas Hoy</h2>
                    <p class="value" th:text="${metricas.mechasUsadas != null ? metricas.mechasUsadas : '95'}">95</p>
                </div>
                
                <div class="metric-card">
                    <i class="fas fa-dollar-sign card-icon red"></i>
                    <h2 th:text="#{metricas.ventaTotal}">Venta Total del Día</h2>
                    <p class="value" th:text="${metricas.ventaTotal != null ? '$\u0020' + metricas.ventaTotal + '\u0020MXN' : '$1,200 MXN'}">
                        $1,200 MXN
                    </p>
                </div>
            </section>

            <section class="live-tables">
                <h2 th:text="#{seccion.canchasTiempos}">Canchas y Tiempos en Curso</h2>
                
                <div class="table-list">
                    <!-- Canchas dinámicas desde el controlador -->
                    <div th:each="cancha : ${canchas}" 
                         th:class="'table-item ' + ${cancha.estado}">
                        <span class="table-number" th:text="${cancha.nombre}">Cancha Los Pinos</span>
                        
                        <span th:if="${cancha.estado == 'occupied'}" class="time-elapsed">
                            <i class="fas fa-hourglass-half"></i> 
                            <span th:text="'Tiempo: ' + ${cancha.tiempoTranscurrido}">Tiempo: 00:45:00</span>
                        </span>
                        
                        <span th:if="${cancha.estado == 'reserved'}" class="time-elapsed">
                            <i class="fas fa-user-clock"></i> 
                            <span th:text="'Reserva a las ' + ${cancha.horaReserva}">Reserva a las 13:30</span>
                        </span>
                        
                        <span th:if="${cancha.estado == 'available'}" class="time-elapsed">
                            <span th:text="#{estado.disponible}">Disponible</span>
                        </span>
                        
                        <span class="action-btn" 
                              th:text="${cancha.estado == 'occupied' ? 'Finalizar Partida' : 
                                      cancha.estado == 'reserved' ? 'Confirmar Llegada' : 
                                      'Asignar Equipo'}"
                              th:onclick="|manejarAccionCancha('${cancha.id}', '${cancha.estado}')|">
                            Finalizar Partida
                        </span>
                    </div>

                    <!-- Mensaje si no hay canchas -->
                    <div th:if="${#lists.isEmpty(canchas)}" class="no-data">
                        <p th:text="#{mensaje.sinCanchas}">No hay canchas configuradas</p>
                    </div>
                </div>
            </section>
            
            <section class="live-tables" style="margin-top: 40px;">
                <h2 th:text="#{seccion.stockCritico}">Stock Crítico (Mechas y Discos)</h2>
                <div class="table-list">
                    
                    <!-- Stock dinámico desde el controlador -->
                    <div th:each="item : ${stockCritico}" 
                         th:class="'table-item item-low'">
                        <span class="table-number">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <span th:text="${item.nombre}">Mechas de Seguridad</span>
                        </span>
                        <span class="time-elapsed" th:text="'Stock: ' + ${item.cantidad} + ' ' + ${item.unidad} + ' (' + ${item.alerta} + ')'">
                            Stock: 10 und. (¡Pedir!)
                        </span>
                        <span class="action-btn" 
                              th:onclick="|irAInventario('${item.id}')|"
                              th:text="#{boton.irInventario}">
                            Ir a Inventario
                        </span>
                    </div>

                    <!-- Mensaje si no hay stock crítico -->
                    <div th:if="${#lists.isEmpty(stockCritico)}" class="no-data">
                        <p th:text="#{mensaje.sinStockCritico}">No hay items con stock crítico</p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Scripts con Thymeleaf -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        function manejarAccionCancha(canchaId, estado) {
            const url = /*[[@{/canchas/accion}]]*/ '/canchas/accion';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': /*[[${_csrf.token}]]*/ 'token'
                },
                body: JSON.stringify({
                    id: canchaId,
                    accion: estado
                })
            }).then(response => {
                if(response.ok) {
                    location.reload();
                }
            });
        }

        function irAInventario(itemId) {
            window.location.href = /*[[@{/inventario}]]*/ '/inventario' + '?item=' + itemId;
        }
        
        // Datos para gráficos (ejemplo)
        const metricasData = {
            ventas: /*[[${metricas.ventaTotal}]]*/ 1200,
            reservas: /*[[${metricas.reservasProximas}]]*/ 5
        };
        /*]]>*/
    </script>
</body>
</html>